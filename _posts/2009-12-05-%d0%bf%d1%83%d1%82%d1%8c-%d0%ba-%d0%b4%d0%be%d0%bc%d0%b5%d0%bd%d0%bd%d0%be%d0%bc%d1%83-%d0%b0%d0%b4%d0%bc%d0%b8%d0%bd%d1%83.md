---
id: 1072
title: Путь к доменному админу
date: 2009-12-05T12:18:00+00:00
author: sapran
layout: post
guid: http://styran.com/2009/12/05/%d0%bf%d1%83%d1%82%d1%8c-%d0%ba-%d0%b4%d0%be%d0%bc%d0%b5%d0%bd%d0%bd%d0%be%d0%bc%d1%83-%d0%b0%d0%b4%d0%bc%d0%b8%d0%bd%d1%83/
permalink: /2009/12/%d0%bf%d1%83%d1%82%d1%8c-%d0%ba-%d0%b4%d0%be%d0%bc%d0%b5%d0%bd%d0%bd%d0%be%d0%bc%d1%83-%d0%b0%d0%b4%d0%bc%d0%b8%d0%bd%d1%83/
blogger_blog:
  - securegalaxy.blogspot.com
blogger_author:
  - Vlad Styran
blogger_permalink:
  - /2009/12/blog-post.html
blogger_internal:
  - /feeds/3388835630659782197/posts/default/3175820837169842982
shorturl:
  - http://tinyurl.com/og7poc5
tags:
  - active directory
  - core security
  - metadata
  - ntlm
  - криптография
  - пароли
  - пентесты
---
<div dir="ltr" style="text-align: left;">
  <div style="text-align: justify;">
    Недавно мне был задан вопрос о том, &#171;как это возможно &#8212; получить права доменного админа?&#187; Оказывается, для многих специалистов в сфере ИБ и ИТ эта цель кажется почти&nbsp;недостижимой. Это не удивительно, так как ИТ-рынок всеми силами старается создать у компаний-заказчиков ложное ощущение безопасности. Вот и получается, что после внедрения ряда технических средств обеспечения безопасности, выполнение такого упражнения кажется им невероятным.
  </div>
  
  <div style="text-align: justify;">
  </div>
  
  <div style="text-align: justify;">
    Сегодня я расскажу о том, как используя ошибочные практики и халатность персонала компании-цели потенциальный злоумышленник может получить&nbsp;привилегированные&nbsp;права в домене Active Directory. Ничего нового опытные специалисты тут не прочитают. Более того, если в компании действует эффективная&nbsp;программа&nbsp;информационной безопасности, то изложенные ниже действия скорее всего осуществить не удастся.
  </div>
  
  <div style="text-align: justify;">
  </div>
  
  <div style="text-align: justify;">
    К сожалению, существует множество факторов, в следствие которых эффективность технических средств обеспечения ИБ может быть существенно понижена. Как правило, это происходит в следствие разнообразных &#171;культурных ограничений&#187;, всяческих &#171;поблажек&#187; для руководства, да и просто из-за небрежности&nbsp;ИТ-персонала. Общая схема атаки:
  </div>
  
  <ol>
    <li style="text-align: justify;">
      Доступ к <b>доменному ПК</b>.
    </li>
    <li style="text-align: justify;">
      Получение прав <b>локального администратора</b>.
    </li>
    <li style="text-align: justify;">
      <b>Извлечение хешей </b>доменного администратора.
    </li>
    <li style="text-align: justify;">
      Получение прав <b>доменного&nbsp;администратора</b>.
    </li>
  </ol>
  
  <div>
    <div style="text-align: justify;">
      Теперь подробнее.
    </div>
  </div>
  
  <div>
    <div style="text-align: justify;">
      <b><br /></b>
    </div>
  </div>
  
  <div>
    <div style="text-align: justify;">
      <b>1. Получить доступ к доменному ПК</b>&nbsp;злоумышленник можно различными способами, здесь ограничением может быть только фантазия. Например, <b>(1) </b>используя <b>физический канал</b>.&nbsp;Злоумышленник может украсть ноутбук сотрудника компании. Или просто войти на территорию под видом подрядчика и усесться за свободный ПК в опенспейсе. Или <b>(2) </b>при помощи <b>канала сети передачи данных</b>. Доставить на ПК сотрудника компании &#171;троянца&#187;, который активирует сервер управления и инициирует обратное соединение к ПК атакующего. Второй вариант, очевидно, менее рискован. Правда, злоумышленнику придется немного подготовиться и сделать &#171;домашнюю работу&#187;, то есть выяснить путем каких уязвимостей возможно получить контроль над ПК жертвы.
    </div>
  </div>
  
  <div>
    <div style="text-align: justify;">
    </div>
  </div>
  
  <div>
    <div style="text-align: justify;">
      <b>2. Получить права локального администратора</b> на ПК жертвы легче всего, если пользователь этого ПК уже обладает такими правами. К сожалению, это не редкость. Многие ИТ-менеджеры, руководители и прочие &#171;приближенные&#187; зачастую наделены привилегиями локального&nbsp;администратора&nbsp;на их персональных рабочих станциях и ноутбуках. И что еще хуже &#8212; почти всегда пользуются&nbsp;привилегированными&nbsp;учетными записями интерактивно, то есть входят в сеанс ОС и выполняют прикладное, зачастую уязвимое, ПО.&nbsp;Если же &#171;попавшийся&#187; пользователь и есть доменный админ, то злоумышленнику либо неслыханно повезло, либо он очень хорошо&nbsp;подготовился.&nbsp;В случае, если с жертвой совсем не подфартило, и пользователь клюнувший на &#171;троянца&#187; даже не локальный админ &#8212; придется выбирать из двух зол. Либо искать технические уязвимости системного (и прочего) ПО на машине-жертве, позволяющие выполнить т.н. <b>эскалацию&nbsp;привилегий</b>, либо искать более подходящий компьютер, за которым сидит локальный админ.
    </div>
  </div>
  
  <div>
    <div style="text-align: justify;">
    </div>
  </div>
  
  <div>
    <div style="text-align: justify;">
      <b>3. С извлечением хешей</b> все предельно просто. Для этих целей существует масса утилит, из которых наиболее известны&nbsp;<a href="http://reedarvin.thearvins.com/tools/">PWDumpX</a>, <a href="http://www.foofus.net/fizzgig/pwdump/">pwdump6</a>&nbsp;(для x86_64), а так же модули <a href="http://www.metasploit.com/">Metasploit Framework</a>&nbsp;<b>hashdump, incognito </b>и т.п. Последний&nbsp;инструмент&nbsp;как нельзя лучше&nbsp;сочетается&nbsp;с методами,&nbsp;используемыми&nbsp;в пунктах 1 и 2.
    </div>
    
    <div style="text-align: justify;">
    </div>
    
    <div style="text-align: justify;">
      Локально кешируемые пароли представляют собой последовательность альфанумерических символов &nbsp;&#8212; <b>LM </b>(LanMan) и <b>NTLM </b>хеши. В этой форме наши пароли&nbsp;хранятся&nbsp;в Windows (в т.н. SAM-файлах) и передаются по сети. Хеш-функции в общем случае необратимы, то есть пароль, который был захеширован, так просто&nbsp;восстановить&nbsp;нельзя. Можно только сравнить с ним другой пароль, &#8212; для этого нужно захешировать&nbsp;его при помощи аналогичной хеш-функции и сравнить результаты. Механизм хеш-функций&nbsp;повсеместно&nbsp;используется&nbsp;для безопасного хранения паролей, поэтому против него был&nbsp;разработан&nbsp;целый ряд криптоаналитических атак.
    </div>
    
    <div style="text-align: justify;">
    </div>
    
    <div style="text-align: justify;">
      Хеши паролей доменных админов практически&nbsp;гарантированно находятся на любом доменном ПК. Эта уязвимость связана с тем, что большинство компаний не следуют <b>принципу наименьших необходимых&nbsp;привилегий</b>&nbsp;в процессе управления правами пользователей. В итоге тех-поддержка и хелпдеск традиционно пользуются правами доменного администратора для того, чтобы помогать пользователям было легче и быстрее. Типичный <b>Easy Button</b>.
    </div>
    
    <div style="text-align: justify;">
    </div>
    
    <div style="clear: both; text-align: center;">
      <a href="http://www.openwall.com/john/jack.jpg" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em; text-align: justify;"><img border="0" src="http://www.openwall.com/john/jack.jpg" /></a>
    </div>
    
    <div style="text-align: justify;">
      <b>4. Получить права доменного администратора</b>,&nbsp;располагая&nbsp;логином и двумя хешами (LM & NTLM) его учетной записи, злоумышленник может несколькими способами. Если есть подозрение, что пароль не слишком длинный и не слишком сложный (скажем, используются алфавит ASCII, длина 8 символов), то эффективными могут оказаться техники&nbsp;<b>bruteforce&nbsp;</b>и <b>rainbow tables</b>. В отличие от bruteforce, в ходе&nbsp;которого&nbsp;просто перебираются все возможные комбинации из N=8 символов заданного алфавита (ASCII), rainbow tables действует хитрее. У атакующего есть заведомо подготовленные таблицы хешей, отвечающих всем этим возможным комбинациям. Подготовка таких таблиц занимает уйму времени и дискового пространства, но зато в результате успех гарантирован в кратчайшее время. Среди инструментов брутфорса выделяется <b><a href="http://www.openwall.com/john/">John The Ripper</a></b>, а rainbow tables либо генерируются злоумышленником самостоятельно, либо скачиваются для определенных длин и алфавитов. Также, существует возможность воспользоваться распределенными системами генерации/взлома хешей, но они как правило стоят немалых денег, ровно как и готовые таблицы для длинных паролей и больших алфавитов.
    </div>
    
    <div style="text-align: justify;">
    </div>
    
    <div style="text-align: justify;">
      Обе описанные техники криптоанализа преследуют цель <b>получения пароля учетной записи в чистом виде</b>. Но это далеко не всегда необходимо. Существуют средства изменения реквизитов текущей сессии, позволяющие атакующему замаскироваться под другого пользователя, в т.ч. и доменного администратора. Думаю вы уже догадались, что для успешного использования этой техники нужны логин и хеши учетной записи доменного администратора. Например, бесплатная утилита <b><a href="http://oss.coresecurity.com/pshtoolkit/doc/index.html">IAM</a> </b>от <b><a href="http://www2.corest.com/">Core Security</a></b> позволяет заменить параметры текущей сессии теми, которые получены в пункте 3. Metasploit также&nbsp;располагает&nbsp;средствами&nbsp;перехвата и&nbsp;присвоения&nbsp;найденных&nbsp;в системе закешрованых реквизитов.
    </div>
    
    <div style="text-align: justify;">
    </div>
    
    <div style="text-align: justify;">
      Надеюсь, эта информация поможет кому-нибудь более критично оценить шансы злоумышленников, и как следствие &#8212; более эффективно построить систему ИБ, способную противостоять описанному сценарию атаки. Некоторые советы по этому поводу я дал в этом посте:&nbsp;<b><a href="http://securegalaxy.blogspot.com/2009/12/blog-post_07.html">Гранд-Каньон на пути к доменному админу</a></b>
    </div>
  </div>
</div>

<div class="addtoany_share_save_container addtoany_content_bottom">
  <div class="a2a_kit a2a_kit_size_32 addtoany_list a2a_target" id="wpa2a_69">
    <a class="a2a_button_facebook" href="http://www.addtoany.com/add_to/facebook?linkurl=https%3A%2F%2Fblog.styran.com%2F2009%2F12%2F%25d0%25bf%25d1%2583%25d1%2582%25d1%258c-%25d0%25ba-%25d0%25b4%25d0%25be%25d0%25bc%25d0%25b5%25d0%25bd%25d0%25bd%25d0%25be%25d0%25bc%25d1%2583-%25d0%25b0%25d0%25b4%25d0%25bc%25d0%25b8%25d0%25bd%25d1%2583%2F&linkname=%D0%9F%D1%83%D1%82%D1%8C%20%D0%BA%20%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC%D1%83%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D1%83" title="Facebook" rel="nofollow" target="_blank"></a><a class="a2a_button_twitter" href="http://www.addtoany.com/add_to/twitter?linkurl=https%3A%2F%2Fblog.styran.com%2F2009%2F12%2F%25d0%25bf%25d1%2583%25d1%2582%25d1%258c-%25d0%25ba-%25d0%25b4%25d0%25be%25d0%25bc%25d0%25b5%25d0%25bd%25d0%25bd%25d0%25be%25d0%25bc%25d1%2583-%25d0%25b0%25d0%25b4%25d0%25bc%25d0%25b8%25d0%25bd%25d1%2583%2F&linkname=%D0%9F%D1%83%D1%82%D1%8C%20%D0%BA%20%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC%D1%83%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D1%83" title="Twitter" rel="nofollow" target="_blank"></a><a class="a2a_button_google_plus" href="http://www.addtoany.com/add_to/google_plus?linkurl=https%3A%2F%2Fblog.styran.com%2F2009%2F12%2F%25d0%25bf%25d1%2583%25d1%2582%25d1%258c-%25d0%25ba-%25d0%25b4%25d0%25be%25d0%25bc%25d0%25b5%25d0%25bd%25d0%25bd%25d0%25be%25d0%25bc%25d1%2583-%25d0%25b0%25d0%25b4%25d0%25bc%25d0%25b8%25d0%25bd%25d1%2583%2F&linkname=%D0%9F%D1%83%D1%82%D1%8C%20%D0%BA%20%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC%D1%83%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D1%83" title="Google+" rel="nofollow" target="_blank"></a><a class="a2a_button_linkedin" href="http://www.addtoany.com/add_to/linkedin?linkurl=https%3A%2F%2Fblog.styran.com%2F2009%2F12%2F%25d0%25bf%25d1%2583%25d1%2582%25d1%258c-%25d0%25ba-%25d0%25b4%25d0%25be%25d0%25bc%25d0%25b5%25d0%25bd%25d0%25bd%25d0%25be%25d0%25bc%25d1%2583-%25d0%25b0%25d0%25b4%25d0%25bc%25d0%25b8%25d0%25bd%25d1%2583%2F&linkname=%D0%9F%D1%83%D1%82%D1%8C%20%D0%BA%20%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE%D0%BC%D1%83%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D1%83" title="LinkedIn" rel="nofollow" target="_blank"></a><a class="a2a_dd addtoany_share_save" href="https://www.addtoany.com/share"></a>
  </div>
</div>